# opal

![Type: application](https://img.shields.io/badge/Type-application-informational?style=flat-square)

A Helm chart for deploying the Opal server and a DataShield rock cluster.

**Homepage:** <https://opaldoc.obiba.org/en/latest/index.html>

## Installation

```sh
helm install --create-namespace -n opal opal oci://ghcr.io/miracum/charts/opal
```

## Values

| Key                                              | Type   | Default                                                                                                                                         | Description                                                                                                                                                                                                                                                                                                                                   |
| ------------------------------------------------ | ------ | ----------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| fullnameOverride                                 | string | `""`                                                                                                                                            | override the full release name                                                                                                                                                                                                                                                                                                                |
| initContainers.resources                         | object | `{}`                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                               |
| initContainers.resourcesPreset                   | string | `"nano"`                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                               |
| logCollectorSidecar.resources                    | object | `{}`                                                                                                                                            | configure the resources used by the log collector sidecar container used to tail the filesystem-stored log files                                                                                                                                                                                                                              |
| logCollectorSidecar.resourcesPreset              | string | `"nano"`                                                                                                                                        | set container resources according to one common preset (allowed values: none, nano, micro, small, medium, large, xlarge, 2xlarge). This is ignored if primary.resources is set (primary.resources is recommended for production). More information: <https://github.com/bitnami/charts/blob/main/bitnami/common/templates/_resources.tpl#L15> |
| nameOverride                                     | string | `""`                                                                                                                                            | override the release name                                                                                                                                                                                                                                                                                                                     |
| opal.affinity                                    | object | `{}`                                                                                                                                            | pod affinity                                                                                                                                                                                                                                                                                                                                  |
| opal.auth.administrator.existingSecret.key       | string | `"opal-administrator-password"`                                                                                                                 | key inside that existing secret that contains the administrator password                                                                                                                                                                                                                                                                      |
| opal.auth.administrator.existingSecret.name      | string | `""`                                                                                                                                            | name of an existing secret that contains the administrator password.                                                                                                                                                                                                                                                                          |
| opal.auth.administrator.password                 | string | `""`                                                                                                                                            | the password for the administrator user. If unset and no existing secret is specified, a random one is generated.                                                                                                                                                                                                                             |
| opal.database.data.database                      | string | `"opal_data"`                                                                                                                                   | name of the database inside. If postgresql.enabled=true, then postgresql.postgresqlDatabase is used                                                                                                                                                                                                                                           |
| opal.database.data.existingSecret.key            | string | `"password"`                                                                                                                                    | name of the key in `database.data.existingSecret.name` to use as the password to the DB.                                                                                                                                                                                                                                                      |
| opal.database.data.existingSecret.name           | string | `""`                                                                                                                                            | name of an existing secret containing the password to the DB.                                                                                                                                                                                                                                                                                 |
| opal.database.data.host                          | string | `"data.host.example.com"`                                                                                                                       | database hostname of an external database used to store data. Only used if `postgresql.enabled` is set to `false`.                                                                                                                                                                                                                            |
| opal.database.data.password                      | string | `"opal_data_password"`                                                                                                                          | the database password. Only used if postgresql.enabled=false, otherwise the secret created by the postgresql chart is used                                                                                                                                                                                                                    |
| opal.database.data.port                          | int    | `5432`                                                                                                                                          | port used to connect to the postgres DB                                                                                                                                                                                                                                                                                                       |
| opal.database.data.username                      | string | `"opal_data_admin"`                                                                                                                             | username used to connect to the DB. Note that this name is currently used even if postgresql.enabled=true                                                                                                                                                                                                                                     |
| opal.database.ids.database                       | string | `"opal_ids"`                                                                                                                                    | name of the database inside. If postgresql.enabled=true, then postgresql.postgresqlDatabase is used                                                                                                                                                                                                                                           |
| opal.database.ids.existingSecret.key             | string | `"password"`                                                                                                                                    | name of the key in `database.data.existingSecret.name` to use as the password to the DB.                                                                                                                                                                                                                                                      |
| opal.database.ids.existingSecret.name            | string | `""`                                                                                                                                            | name of an existing secret containing the password to the DB.                                                                                                                                                                                                                                                                                 |
| opal.database.ids.host                           | string | `"data.host.example.com"`                                                                                                                       | database hostname of an external database used to store ids. Only used if `postgresql.enabled` is set to `false`.                                                                                                                                                                                                                             |
| opal.database.ids.password                       | string | `"opal"`                                                                                                                                        | the database password. Only used if postgresql.enabled=false, otherwise the secret created by the postgresql chart is used                                                                                                                                                                                                                    |
| opal.database.ids.port                           | int    | `5432`                                                                                                                                          | port used to connect to the postgres DB                                                                                                                                                                                                                                                                                                       |
| opal.database.ids.username                       | string | `"opal_ids_password"`                                                                                                                           | username used to connect to the DB. Note that this name is currently used even if postgresql.enabled=true                                                                                                                                                                                                                                     |
| opal.extraEnv                                    | list   | `[]`                                                                                                                                            | extra environment variables to set on the opal api container                                                                                                                                                                                                                                                                                  |
| opal.imagePullSecrets                            | list   | `[]`                                                                                                                                            | image pull secrets used by the opal container                                                                                                                                                                                                                                                                                                 |
| opal.ingress.annotations                         | object | `{}`                                                                                                                                            | extra annotations to apply to the Ingress resource                                                                                                                                                                                                                                                                                            |
| opal.ingress.className                           | string | `""`                                                                                                                                            | ingressClassName to use                                                                                                                                                                                                                                                                                                                       |
| opal.ingress.enabled                             | bool   | `false`                                                                                                                                         | create an Ingress for the application                                                                                                                                                                                                                                                                                                         |
| opal.ingress.hosts                               | list   | `[{"host":"opal.127.0.0.1.nip.io","paths":[{"path":"/","pathType":"ImplementationSpecific","portName":"http"}]}]`                               | list of ingress hosts                                                                                                                                                                                                                                                                                                                         |
| opal.ingress.tls                                 | list   | `[]`                                                                                                                                            | TLS configuration                                                                                                                                                                                                                                                                                                                             |
| opal.javaOpts                                    | string | `"-XX:+UseG1GC -XX:+UseContainerSupport"`                                                                                                       | sets the value for the `JAVA_OPTS` environment variable                                                                                                                                                                                                                                                                                       |
| opal.networkPolicy.enabled                       | bool   | `true`                                                                                                                                          | whether to create a NetworkPolicy for the rock pods                                                                                                                                                                                                                                                                                           |
| opal.networkPolicy.extraEgress                   | list   | `[]`                                                                                                                                            | add extra egress rules to the NetworkPolicy                                                                                                                                                                                                                                                                                                   |
| opal.networkPolicy.extraIngress                  | list   | `[]`                                                                                                                                            | add extra ingress rules to the NetworkPolicy. Necessary for e.g. ingress controllers.                                                                                                                                                                                                                                                         |
| opal.nodeSelector                                | object | `{}`                                                                                                                                            | pod node selector                                                                                                                                                                                                                                                                                                                             |
| opal.persistence                                 | object | `{"accessModes":["ReadWriteOnce"],"annotations":{},"enabled":true,"existingClaim":"","labels":{},"selector":{},"size":"8Gi","storageClass":""}` | configuration for the server persistence                                                                                                                                                                                                                                                                                                      |
| opal.persistence.accessModes                     | list   | `["ReadWriteOnce"]`                                                                                                                             | PVC Access Mode for data volume                                                                                                                                                                                                                                                                                                               |
| opal.persistence.annotations                     | object | `{}`                                                                                                                                            | annotations for the PVC                                                                                                                                                                                                                                                                                                                       |
| opal.persistence.enabled                         | bool   | `true`                                                                                                                                          | enable data persistence using PVC                                                                                                                                                                                                                                                                                                             |
| opal.persistence.existingClaim                   | string | `""`                                                                                                                                            | name of an existing PVC to use                                                                                                                                                                                                                                                                                                                |
| opal.persistence.labels                          | object | `{}`                                                                                                                                            | labels for the PVC                                                                                                                                                                                                                                                                                                                            |
| opal.persistence.selector                        | object | `{}`                                                                                                                                            | selector to match an existing Persistent Volume (this value is evaluated as a template) selector: matchLabels: app: my-app                                                                                                                                                                                                                    |
| opal.persistence.size                            | string | `"8Gi"`                                                                                                                                         | PVC Storage Request for volume                                                                                                                                                                                                                                                                                                                |
| opal.persistence.storageClass                    | string | `""`                                                                                                                                            | PVC Storage Class for data volume If defined, storageClassName: <storageClass> If set to "-", storageClassName: "", which disables dynamic provisioning If undefined (the default) or set to null, no storageClassName spec is set, choosing the default provisioner.                                                                         |
| opal.pod.spec                                    | list   | `[]`                                                                                                                                            | YAML pod spec for the rock pods when using the Kubernetes pod spawner. This value is evaluated as a template. set to `[]` to disable.                                                                                                                                                                                                         |
| opal.podAnnotations                              | object | `{}`                                                                                                                                            | annotations to set on the opal pod                                                                                                                                                                                                                                                                                                            |
| opal.podSecurityContext                          | object | `{"fsGroup":10041,"runAsNonRoot":true}`                                                                                                         | the pod security context                                                                                                                                                                                                                                                                                                                      |
| opal.replicaCount                                | int    | `1`                                                                                                                                             | number of replicas. Should be kept as 1 unless ReadWriteMany persistence is used                                                                                                                                                                                                                                                              |
| opal.resources                                   | object | `{}`                                                                                                                                            | resource limits and requests                                                                                                                                                                                                                                                                                                                  |
| opal.resourcesPreset                             | string | `"small"`                                                                                                                                       | set container resources according to one common preset (allowed values: none, nano, micro, small, medium, large, xlarge, 2xlarge). This is ignored if primary.resources is set (primary.resources is recommended for production). More information: <https://github.com/bitnami/charts/blob/main/bitnami/common/templates/_resources.tpl#L15> |
| opal.service.httpsPort                           | int    | `8443`                                                                                                                                          | the port for the TLS-secured interface                                                                                                                                                                                                                                                                                                        |
| opal.service.port                                | int    | `8080`                                                                                                                                          | the port for the main web interface                                                                                                                                                                                                                                                                                                           |
| opal.service.sshPort                             | int    | `8022`                                                                                                                                          | the port for SSH access                                                                                                                                                                                                                                                                                                                       |
| opal.service.type                                | string | `"ClusterIP"`                                                                                                                                   | the type of service                                                                                                                                                                                                                                                                                                                           |
| opal.serviceAccount.annotations                  | object | `{}`                                                                                                                                            | Annotations to add to the service account                                                                                                                                                                                                                                                                                                     |
| opal.serviceAccount.automountServiceAccountToken | bool   | `false`                                                                                                                                         | whether to automount the SA token.                                                                                                                                                                                                                                                                                                            |
| opal.serviceAccount.create                       | bool   | `false`                                                                                                                                         | Specifies whether a service account should be created.                                                                                                                                                                                                                                                                                        |
| opal.serviceAccount.name                         | string | `""`                                                                                                                                            | The name of the service account to use. If not set and create is true, a name is generated using the fullname template                                                                                                                                                                                                                        |
| opal.tolerations                                 | list   | `[]`                                                                                                                                            | pod tolerations                                                                                                                                                                                                                                                                                                                               |
| postgres.auth.database                           | string | `"opal"`                                                                                                                                        | name of the database to create                                                                                                                                                                                                                                                                                                                |
| postgres.auth.enablePostgresUser                 | bool   | `false`                                                                                                                                         | disable the default postgres user                                                                                                                                                                                                                                                                                                             |
| postgres.auth.username                           | string | `"opal_admin"`                                                                                                                                  | username for the database user                                                                                                                                                                                                                                                                                                                |
| postgres.enabled                                 | bool   | `true`                                                                                                                                          | enabled the included Postgres DB see <https://github.com/CloudPirates-io/helm-charts/tree/main/charts/postgres> for configuration options                                                                                                                                                                                                     |
| rock.affinity                                    | object | `{}`                                                                                                                                            | pod affinity                                                                                                                                                                                                                                                                                                                                  |
| rock.auth.administrator.existingSecret.key       | string | `"rock-administrator-password"`                                                                                                                 | key inside that existing secret that contains the administrator password                                                                                                                                                                                                                                                                      |
| rock.auth.administrator.existingSecret.name      | string | `""`                                                                                                                                            | name of an existing secret that contains the administrator password.                                                                                                                                                                                                                                                                          |
| rock.auth.administrator.name                     | string | `"administrator"`                                                                                                                               | the user name for the administrator user.                                                                                                                                                                                                                                                                                                     |
| rock.auth.administrator.password                 | string | `""`                                                                                                                                            | the password for the administrator user. If unset and no existing secret is specified, a random one is generated.                                                                                                                                                                                                                             |
| rock.auth.manager.existingSecret.key             | string | `"rock-manager-password"`                                                                                                                       | key inside that existing secret that contains the manager password                                                                                                                                                                                                                                                                            |
| rock.auth.manager.existingSecret.name            | string | `""`                                                                                                                                            | name of an existing secret that contains the manager password.                                                                                                                                                                                                                                                                                |
| rock.auth.manager.name                           | string | `"manager"`                                                                                                                                     | the user name for the manager user.                                                                                                                                                                                                                                                                                                           |
| rock.auth.manager.password                       | string | `""`                                                                                                                                            | the password for the manager user. If unset and no existing secret is specified, a random one is generated.                                                                                                                                                                                                                                   |
| rock.auth.user.existingSecret.key                | string | `"rock-user-password"`                                                                                                                          | key inside that existing secret that contains the user password                                                                                                                                                                                                                                                                               |
| rock.auth.user.existingSecret.name               | string | `""`                                                                                                                                            | name of an existing secret that contains the user password.                                                                                                                                                                                                                                                                                   |
| rock.auth.user.name                              | string | `"user"`                                                                                                                                        | the user name for the user user.                                                                                                                                                                                                                                                                                                              |
| rock.auth.user.password                          | string | `""`                                                                                                                                            | the password for the user. If unset and no existing secret is specified, a random one is generated.                                                                                                                                                                                                                                           |
| rock.clusterName                                 | string | `"default"`                                                                                                                                     | rock cluster name. Evaluated as a template                                                                                                                                                                                                                                                                                                    |
| rock.javaOpts                                    | string | `"-XX:+UseG1GC"`                                                                                                                                | sets the value for the `JAVA_OPTS` environment variable                                                                                                                                                                                                                                                                                       |
| rock.networkPolicy.enabled                       | bool   | `true`                                                                                                                                          | whether to create a NetworkPolicy for the rock pods                                                                                                                                                                                                                                                                                           |
| rock.networkPolicy.extraEgress                   | list   | `[]`                                                                                                                                            | Add extra egress rules to the NetworkPolicy If R packages are to be installed, egress to CRAN is needed and needs to be manually added.                                                                                                                                                                                                       |
| rock.networkPolicy.extraIngress                  | list   | `[]`                                                                                                                                            | add extra ingress rules to the NetworkPolicy                                                                                                                                                                                                                                                                                                  |
| rock.nodeSelector                                | object | `{}`                                                                                                                                            | pod node selector                                                                                                                                                                                                                                                                                                                             |
| rock.persistence                                 | object | `{"accessModes":["ReadWriteOnce"],"annotations":{},"enabled":true,"existingClaim":"","labels":{},"selector":{},"size":"8Gi","storageClass":""}` | configuration for the server persistence                                                                                                                                                                                                                                                                                                      |
| rock.persistence.accessModes                     | list   | `["ReadWriteOnce"]`                                                                                                                             | PVC Access Mode for data volume                                                                                                                                                                                                                                                                                                               |
| rock.persistence.annotations                     | object | `{}`                                                                                                                                            | annotations for the PVC                                                                                                                                                                                                                                                                                                                       |
| rock.persistence.enabled                         | bool   | `true`                                                                                                                                          | enable data persistence using PVC                                                                                                                                                                                                                                                                                                             |
| rock.persistence.existingClaim                   | string | `""`                                                                                                                                            | name of an existing PVC to use                                                                                                                                                                                                                                                                                                                |
| rock.persistence.labels                          | object | `{}`                                                                                                                                            | labels for the PVC                                                                                                                                                                                                                                                                                                                            |
| rock.persistence.selector                        | object | `{}`                                                                                                                                            | selector to match an existing Persistent Volume (this value is evaluated as a template) selector: matchLabels: app: my-app                                                                                                                                                                                                                    |
| rock.persistence.size                            | string | `"8Gi"`                                                                                                                                         | PVC Storage Request for volume                                                                                                                                                                                                                                                                                                                |
| rock.persistence.storageClass                    | string | `""`                                                                                                                                            | PVC Storage Class for data volume If defined, storageClassName: <storageClass> If set to "-", storageClassName: "", which disables dynamic provisioning If undefined (the default) or set to null, no storageClassName spec is set, choosing the default provisioner.                                                                         |
| rock.podSecurityContext                          | object | `{"fsGroup":10041,"fsGroupChangePolicy":"OnRootMismatch","runAsNonRoot":true}`                                                                  | pod security context                                                                                                                                                                                                                                                                                                                          |
| rock.replicaCount                                | int    | `1`                                                                                                                                             | number of rock instances in the cluster                                                                                                                                                                                                                                                                                                       |
| rock.resources                                   | object | `{}`                                                                                                                                            | resource limits and requests                                                                                                                                                                                                                                                                                                                  |
| rock.resourcesPreset                             | string | `"small"`                                                                                                                                       | set container resources according to one common preset (allowed values: none, nano, micro, small, medium, large, xlarge, 2xlarge). This is ignored if primary.resources is set (primary.resources is recommended for production). More information: <https://github.com/bitnami/charts/blob/main/bitnami/common/templates/_resources.tpl#L15> |
| rock.service.port                                | int    | `8085`                                                                                                                                          | the port for the REST API                                                                                                                                                                                                                                                                                                                     |
| rock.service.type                                | string | `"ClusterIP"`                                                                                                                                   | the type of service                                                                                                                                                                                                                                                                                                                           |
| rock.serviceAccount.annotations                  | object | `{}`                                                                                                                                            | Annotations to add to the service account                                                                                                                                                                                                                                                                                                     |
| rock.serviceAccount.automountServiceAccountToken | bool   | `false`                                                                                                                                         | whether to automount the SA token.                                                                                                                                                                                                                                                                                                            |
| rock.serviceAccount.create                       | bool   | `false`                                                                                                                                         | Specifies whether a service account should be created.                                                                                                                                                                                                                                                                                        |
| rock.serviceAccount.name                         | string | `""`                                                                                                                                            | The name of the service account to use. If not set and create is true, a name is generated using the fullname template                                                                                                                                                                                                                        |
| rock.tolerations                                 | list   | `[]`                                                                                                                                            | pod tolerations                                                                                                                                                                                                                                                                                                                               |
| tests.automountServiceAccountToken               | bool   | `false`                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                               |
| tests.resources                                  | object | `{}`                                                                                                                                            | configure the test pods resource requests and limits                                                                                                                                                                                                                                                                                          |
| tests.resourcesPreset                            | string | `"nano"`                                                                                                                                        | set container resources according to one common preset (allowed values: none, nano, micro, small, medium, large, xlarge, 2xlarge). This is ignored if primary.resources is set (primary.resources is recommended for production). More information: <https://github.com/bitnami/charts/blob/main/bitnami/common/templates/_resources.tpl#L15> |
