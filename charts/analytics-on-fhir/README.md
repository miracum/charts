# analytics-on-fhir

![Type: application](https://img.shields.io/badge/Type-application-informational?style=flat-square)

A Helm chart for deploying a fully-integrated FHIR-based analytics solution.

**Homepage:** <https://github.com/miracum/charts>

## Installation

```sh
helm repo add miracum https://miracum.github.io/charts
helm repo update
helm install --create-namespace vfps miracum/vfps -n vfps
```

> **Warning**
> By default, the included [PostgreSQL Helm chart](https://github.com/bitnami/charts/tree/master/bitnami/postgresql#upgrading)
> auto-generates a random password for the database which may cause problems when upgrading the chart (see [here for details](https://github.com/bitnami/charts/tree/master/bitnami/postgresql#upgrading)).

## Usage

```sh
kubectl run --namespace=vfps -i --tty --rm --image=ghcr.io/miracum/vfps-grpc-utils:latest --restart=Never vfps-tester -- bash

nobody@debug:/$ grpcurl \
  -plaintext \
  -import-path=/tmp/protos/ \
  -proto=Protos/vfps/api/v1/namespaces.proto \
  -d '{"name": "test", "pseudonymGenerationMethod": "PSEUDONYM_GENERATION_METHOD_SECURE_RANDOM_BASE64URL_ENCODED", "pseudonymLength": 32}' \
  vfps-headless:8081 \
  vfps.api.v1.NamespaceService/Create

nobody@debug:/$ ghz --duration=1m \
  --connections=3 \
  --lb-strategy=round_robin \
  --cpus=3 \
  --insecure \
  --enable-compression \
  --import-paths=/tmp/protos/ \
  --proto=Protos/vfps/api/v1/pseudonyms.proto \
  --call=vfps.api.v1.PseudonymService/Create \
  -d '{"originalValue": "{{ randomString 32 }}", "namespace": "test"}' \
  dns:///vfps-headless:8081
```

## Values

| Key                                                    | Type   | Default                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | Description |
| ------------------------------------------------------ | ------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| hive-metastore.extraEnv[0].name                        | string | `"AWS_ACCESS_KEY_ID"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |             |
| hive-metastore.extraEnv[0].valueFrom.secretKeyRef.key  | string | `"accesskey"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |             |
| hive-metastore.extraEnv[0].valueFrom.secretKeyRef.name | string | `"minio-credentials"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |             |
| hive-metastore.extraEnv[1].name                        | string | `"AWS_SECRET_ACCESS_KEY"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |             |
| hive-metastore.extraEnv[1].valueFrom.secretKeyRef.key  | string | `"secretkey"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |             |
| hive-metastore.extraEnv[1].valueFrom.secretKeyRef.name | string | `"minio-credentials"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |             |
| hive-metastore.hiveSiteXmlTemplate                     | string | `"<?xml version=\"1.0\"?>\n<configuration>\n    <property>\n        <name>hive.metastore.warehouse.dir</name>\n        <value>s3a://fhir/metastore</value>\n    </property>\n    <property>\n        <name>fs.s3.impl</name>\n        <value>org.apache.hadoop.fs.s3a.S3AFileSystem</value>\n    </property>\n    <property>\n        <name>fs.s3n.impl</name>\n        <value>org.apache.hadoop.fs.s3a.S3AFileSystem</value>\n    </property>\n    <property>\n        <name>fs.s3a.endpoint</name>\n        <value>http://minio:9000</value>\n    </property>\n    <property>\n        <name>fs.s3a.path.style.access</name>\n        <value>true</value>\n    </property>\n    <property>\n        <name>javax.jdo.option.ConnectionURL</name>\n        <value>jdbc:postgresql://metastore-db:5432/metastore</value>\n    </property>\n    <property>\n        <name>javax.jdo.option.ConnectionDriverName</name>\n        <value>org.postgresql.Driver</value>\n    </property>\n    <property>\n        <name>metastore.storage.schema.reader.impl</name>\n        <value>org.apache.hadoop.hive.metastore.SerDeStorageSchemaReader</value>\n    </property>\n    <property>\n        <name>hive.security.authorization.createtable.owner.grants</name>\n        <value>ALL</value>\n        <description>The set of privileges automatically granted to the owner whenever a table gets\n            created.\n        </description>\n    </property>\n    <property>\n        <name>hive.security.metastore.authorization.auth.reads</name>\n        <value>true</value>\n    </property>\n    <property>\n        <name>hive.users.in.admin.role</name>\n        <value>admin</value>\n    </property>\n    <property>\n        <name>hive.input.format</name>\n        <value>io.delta.hive.HiveInputFormat</value>\n    </property>\n    <property>\n        <name>hive.tez.input.format</name>\n        <value>io.delta.hive.HiveInputFormat</value>\n    </property>\n</configuration>\n"` |             |
| hive-metastore.postgres.nameOverride                   | string | `"hive-metastore-postgres"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |             |
| pathling-server.minio.defaultBucket                    | string | `"fhir"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |             |
| pathling-server.warehouse.url                          | string | `"s3://fhir"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |             |
| superset                                               | object | `{}`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |             |
| trino                                                  | object | `{}`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |             |
